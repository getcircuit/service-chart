{{ $namespace := .Values.namespace | default "apps" }}

{{- range $k, $environment := .Values.environments }}

{{ $secretName := printf "%s--%s" $environment.name $.Values.name }}
{{ if $environment.production }}
  {{ $secretName = $.Values.name }}
{{- end }}

{{ $shouldRender := false }}
{{- range $key, $value := $environment.env}}
  {{- if kindIs "map" $value}}
    {{ $shouldRender = true }}
  {{end}}
{{end}}
{{- if $environment.volumes }}
{{- if $environment.volumes.secrets }}
  {{- range $j, $value := $environment.volumes.secrets }}
    {{- if kindIs "map" $value.fromRemote }}
      {{ $shouldRender = true }}
    {{end}}
  {{end}}
{{end}}
{{end}}

{{- if $shouldRender }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $secretName }}
  namespace: {{ $namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: cluster-gcpsm-secret-store
  target: {}
  data:
  {{- range $key, $value := $environment.env}}
    {{- if kindIs "map" $value}}
    {{- $secret := $value.fromSecret }}
  - secretKey: {{ printf "%s-%s" $key (join "-version-env-" (list $secret.name $secret.version)) }}
    remoteRef: 
      key: {{ $secret.name | quote }}
      version: {{ $secret.version | quote }}
    {{- end}}
  {{- end }}

  {{- if $environment.volumes }}
  {{- if $environment.volumes.secrets }}
  {{- range $j, $value := $environment.volumes.secrets }}
    {{- if kindIs "map" $value.fromRemote }}
    {{- $secret := $value.fromRemote }}
  - secretKey: {{ printf "%s-%s" $value.name (join "-version-mount-" (list $secret.name $secret.version)) }}
    remoteRef: 
      key: {{ $secret.name | quote }}
      version: {{ $secret.version | quote }}
    {{- end }}
  {{- end }}
  {{- end }}
  {{- end }}
---
{{- end }}
{{- end }}
